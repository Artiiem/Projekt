---
title: "projekt"
author: "Artur Kidaj, Kamil Kopiński"
date: "2023-10-12"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Do zrobienia w projekcie:
- Lepsza wizualizacja i jej opis  (*) - Kamil
- ładna wizualizacja naszych wyników, np wyniki testów w ładnej tabeli
- Ładny opis wyników także  (*) - Kamil

- Przenieść na Quarto, bo ładniej wygląda

- Może zrobić korelacje zmiennych jakościowych np. test chi^2 i inne


- praca nad modelem
- zrobić więcej modeli

- stworzyć jednorodny styl tabeli (rozkład,styl tekstu i obramowań,kolory, itp.).
- przenieść wykresy do plotly::ggplotly().
- dodać do obecnego modelu zmienne jakościowe.
- opisać model.
- w budowie modelu skorzystać z zajęć 'wielowymiarowej analizy danych' - jakieś PCA.
- pogrupować listę pomysłów w działy np. opisy,estetyka,modele itp. oraz dodać znaczek że aktualnie ktoś się tym zajmuje np. (*).
- zrobić las losowy  (*) - Kamil


```{r echo=FALSE , warning=FALSE, include=FALSE}
library(openxlsx)
library(knitr)
library(gt)
library(tidyverse)
library(PerformanceAnalytics)
library(gtsummary)
library(lmtest)
library(nortest)
library(ivreg)
library(caret)

library(rstatix)
```

## Wczytanie danych

```{r}
data <- read.csv("udemy_courses.csv")

# usunięcie bezużytecznych kolumn
data <- data[,-3]  
data <- data[,-1]
```

W naszym projekcie skupimy się na analizie bazy danych "Udemy courses".

Oto pierwsze pięć wierszy z tabeli.

```{r}
gt(head(data,5)) %>% 
    cols_width(course_title ~ px(190),
               num_subscribers ~ px(180),
               num_reviews ~ px(150),
               num_lectures ~ px(150),
               level ~ px(100),
               content_duration ~ px(200),
               published_timestamp ~px(200),
               subject ~ px(150),
               everything() ~ px(70),
               ) %>% 
  tab_style(
    style = cell_text(
      weight = 'bold',
      transform = 'uppercase'
    ),
    locations = cells_column_labels()
  ) %>% 
  tab_style(
    style = cell_text(
      weight = 'bold',
      style = 'italic'
    ),
    locations = cells_body(columns = course_title)
  ) %>% 
  tab_style(
    style = cell_text(
      style = 'italic'
    ),
    locations = cells_body(columns = c(is_paid,level,subject))
  ) %>% 
  tab_style(
    style=cell_borders(sides = "r", color = "gray50", weight = px(2)),
    locations = list(
      cells_body(columns = course_title),
      cells_column_labels(columns = course_title)
      )
  )
```

## Zmienne

-   course_title - Tytuł kursu.

-   is_paid - Informuje o tym, czy dany kurs jest płatny.

-   price - Ukazuje cenę kursu wyrażoną w dolarach.

-   num_subscribers - Ukazuje liczbę subskrybentów kursu.

-   num_reviews - Ukazuje liczbę recenzji kursu.

-   num_lectures - Ukazuje liczbę wykładów kursu.

-   level - Przedstawia poziom trudności kursu podzielną na cztery kategorie:

    -   *Beginner Level* - poziom początkujący.

    -   *Intermediate Level* - poziom średniozaawansowany.

    -   *Expert Level* - poziom zaawansowany.

    -   *All levels* - wszystkie poziomy.

-   content_duration - Ukazuje długość kursu wyrażoną w godzinach.

-   published_timestamp - Przedstawia datę publikacji kursu o następującej strukturze:

    *rok-miesiąc-dzień T - godzina:minuta:sekunda Z*

-   subject - Przedstawia temat kursu wyrażonego w czterech różnych kategoriach:

    -   *Business Finance* - finanse? finanse przedsiębiorstw?

    -   *Graphic Design* -projekt graficzny.

    -   *Musical Instruments* - muzyczne instrumenty.

    -   *Web Development* - tworzenie/rozwój stron internetowych.

## Czyszczenie i przygotowanie danych

Czyszczenie danych

```{r}
data_clean <- data %>%
  filter(!is.na(price)) %>%
  mutate(price = as.numeric(price))
```

Sprawdzenie czy nie ma powtarzających się rekordów

```{r}
powtarzajace = data[duplicated(data),]
liczba = nrow(powtarzajace)
liczba
```

W pliku znalazło się 6 takich samych rekordów, więc je teraz usunę

```{r}
data_cleaned <- data %>% distinct()
```

Transformacja danych

```{r}
data$level <- factor(data$level, levels = names(sort(table(data$level), decreasing = TRUE)))  # zamiana chr na posortowany factor
data$is_paid = factor(data$is_paid)  # zamiana chr na factor
data$subject = factor(data$subject)
data$published_timestamp = substr(data$published_timestamp, 1, 7) # skrócenie daty do miesiąca i roku
```

## Analiza eksploracyjna

Podstawowe statystyki

```{r}
data %>% 
  select(where(is.numeric)) %>% 
  get_summary_stats(show=c('min','q1','median','mean','q3','max')) %>% 
  select(-n) %>% 
  gt() %>% 
  tab_style(
    style = cell_text(
      weight = 'bold',
      transform = 'uppercase'
    ),
    locations = cells_column_labels()
  ) %>% 
  tab_style(
    style = cell_text(
      weight = 'bold',
      style = 'italic'
    ),
    locations = cells_body(columns = variable)
  ) %>% 
  tab_style(
    style=cell_borders(sides = "r", color = "gray50", weight = px(2)),
    locations = list(
      cells_body(columns = variable),
      cells_column_labels(columns = variable)
      )) %>% 
  tab_style(
    style = cell_fill(color = "#00ffff",alpha=0.7),
    locations = cells_body(columns= max)
    ) %>% 
  tab_style(
    style = cell_fill(color = "#00ffff",alpha=0.65),
    locations = cells_body(columns= q3)
    ) %>%
    tab_style(
    style = cell_fill(color = "#00ffff",alpha=0.6),
    locations = cells_body(columns= mean)
    ) %>%
    tab_style(
    style = cell_fill(color = "#00ffff",alpha=0.55),
    locations = cells_body(columns= median)
    ) %>%
    tab_style(
    style = cell_fill(color = "#00ffff",alpha=0.5),
    locations = cells_body(columns= q1)
    ) %>%
    tab_style(
    style = cell_fill(color = "#00ffff",alpha=0.45),
    locations = cells_body(columns= min)
    ) %>% 
    tab_style(
    style = list(
      cell_fill(color = "black",alpha=0.9),
      cell_text(color = 'white')
    ),
    locations = list(cells_body(columns= variable),cells_column_labels())
    )


```


Na podstawie podanych statystyk, możemy wywnioskować kilka rzeczy o kursach zawartych w zbiorze danych:

Różnorodność cen: Kursy na Udemy mają szeroki zakres cen, od darmowych (0 USD) do 200 USD. Średnia cena wynosi 66.05 USD, co wskazuje, że chociaż są kursy droższe, wiele z nich ma umiarkowaną cenę.

Popularność kursów: Liczba subskrybentów kursów jest bardzo zróżnicowana, z minimum 0 (co może oznaczać nowe kursy lub takie, które nie zyskały jeszcze popularności) do maksymalnej liczby subskrybentów wynoszącej 268,923. Mediana liczby subskrybentów wynosi 911,5, co oznacza, że połowa kursów ma mniej niż 912 subskrybentów, a połowa więcej. Średnia liczba subskrybentów jest znacznie wyższa (3197,2), co jest pociągnięte w górę przez kursy o wyjątkowo wysokiej liczbie subskrybentów.

Aktywność recenzentów: Liczba recenzji również się waha, z minimum 0 do maksimum 27,445. Średnia liczba recenzji wynosi 156,3, co wskazuje, że kursy są oceniane przez uczniów, ale istnieje znacząca różnica między najbardziej a najmniej ocenianymi kursami.

Zawartość kursu: Liczba wykładów waha się od 0 do 779, z medianą 25 i średnią 40,11. To sugeruje, że większość kursów ma dość ograniczoną liczbę wykładów, ale niektóre kursy oferują znacznie więcej materiału.

Poziom trudności: Poziom trudności kursów jest reprezentowany jako zmienna kategorialna, ale nie mamy tutaj danych dotyczących rozkładu tych kategorii.

Czas trwania treści: Czas trwania treści kursów ma szeroki zakres od 0 do 78,5 godzin, z medianą wynoszącą 2 godziny i średnią 4,095 godziny. To wskazuje, że większość kursów ma krótkie treści, ale są kursy, które są znacznie dłuższe.

Ogólnie, te statystyki wskazują na dużą różnorodność kursów dostępnych na Udemy, zarówno pod względem ceny, zawartości, jak i popularności. Możemy również wywnioskować, że kursy są w różnych przedziałach cenowych, co czyni je dostępnymi dla różnych grup demograficznych, a także pokazuje, że niektóre kursy są wyjątkowo popularne, co może wskazywać na wysoką jakość lub skuteczne marketingowe wsparcie.

## Wizualizacja danych

----------- Zrobić wykres ilości wszystkiego w czasie

Wizualizacja rozkładu ceny kursów

```{r}
ggplot(data, aes(x = price)) + 
  geom_histogram(bins = 30, fill = "blue", color = "black") +
  theme_minimal() +
  labs(title = "Rozkład ceny kursów", x = "Cena", y = "Liczba kursów")
```

```{r}
data %>%
  group_by(subject) %>%
  summarise(count = n()) %>%
  ggplot(aes(x = reorder(subject, -count), y = count, fill = subject)) +
  geom_bar(stat = "identity") +
  theme_minimal() +
  labs(title = "Liczba kursów w każdej kategorii", x = "Kategoria", y = "Liczba kursów") +
  coord_flip() + 
  theme(legend.position = "none")

```

Wysoka liczba kursów w kategoriach "Finanse Biznesowe" i "Rozwój Stron Internetowych" może wskazywać na znaczny popyt na edukację w tych obszarach. Może to być związane z rosnącą potrzebą kompetencji w dziedzinie finansów i technologii, co jest istotne w obecnym krajobrazie ekonomicznym i zawodowym.Rozwój rynku pracy może preferować umiejętności związane z IT i biznesem, co tłumaczyłoby większą dostępność kursów w tych dziedzinach.


```{r}
data_subscribers <- data %>% 
  filter(num_subscribers < 10000) %>% 
  select(num_subscribers) %>% 
  mutate(category = "Subscribers")

data_reviews <- data %>% 
  filter(num_reviews < 1000) %>% 
  select(num_reviews) %>% 
  mutate(category = "Reviews")

# Połączenie danych
combined_data <- bind_rows(
  data_subscribers %>% rename(value = num_subscribers),
  data_reviews %>% rename(value = num_reviews)
)

# Tworzenie wykresu
ggplot(combined_data, aes(x = value, fill = category)) +
  geom_histogram(bins = 20, color = "black") +
  facet_grid(~category, scales = "free_x") +
  scale_fill_manual(values = c("Subscribers" = "green", "Reviews" = "orange")) +
  labs(title = "Histogramy liczby subskrybentów i recenzji", x = "Liczba", y = "Liczba kursów") +
  theme_minimal()
```
Rozkład Recenzji: Histogram recenzji (pomarańczowy) pokazuje, że większość kursów ma niewielką liczbę recenzji, z silnie skośnym rozkładem w kierunku mniejszej liczby recenzji. Istnieje duże skupisko kursów z mniej niż 250 recenzjami, co może wskazywać na to, że wiele kursów jest stosunkowo nowych lub mniej popularnych.

Rozkład Subskrybentów: Histogram subskrybentów (zielony) również pokazuje skośny rozkład, ale z nieco innym profilem niż histogram recenzji. Większość kursów ma mniej niż 2500 subskrybentów, z największym skupiskiem w okolicy poniżej 1000. To może sugerować, że kursy te są albo nowe, albo mają wąską grupę docelową.

Analiza Skośności: Obie dystrybucje wykazują wysoką skośność pozytywną, co oznacza, że mała liczba kursów ma wyjątkowo wysoką liczbę recenzji lub subskrybentów. To może wskazywać na istnienie niewielkiej grupy bardzo popularnych kursów.

Podsumowując, wykresy te mogą wskazywać na rynek zdominowany przez kilka bardzo popularnych kursów, z dużą liczbą kursów walczących o uwagę i subskrypcje. Dane te mogą być przydatne dla twórców kursów w celu zrozumienia dynamiki rynku i w identyfikacji potencjalnych obszarów do rozwoju ich oferty edukacyjnej.

```{r}
ggplot(data, aes(x = level, fill = level)) +
  geom_bar() +
  labs(title = "Rozkład poziomu kursów", x = "Poziom", y = "Liczba kursów") +
  theme_minimal() + 
  theme(legend.position = "none")
```


Dominacja Kursów Ogólnych: Największa liczba kursów jest przeznaczona dla uczniów na wszystkich poziomach zaawansowania (All Levels). To wskazuje, że twórcy kursów preferują tworzyć materiały, które są dostosowane do szerokiej publiczności, co może być strategią mającą na celu maksymalizację potencjalnego zasięgu i zainteresowania.

Kursy dla Początkujących: Kursy przeznaczone dla początkujących (Beginner Level) stanowią drugą co do wielkości grupę, co może świadczyć o wysokim zapotrzebowaniu na materiały edukacyjne dla osób, które dopiero rozpoczynają naukę w danej dziedzinie.

Niewielka Liczba Kursów dla Zaawansowanych: Znacznie mniejsza liczba kursów jest przeznaczona dla uczniów na poziomie średnio zaawansowanym (Intermediate Level) i zaawansowanym (Expert Level). To może sugerować, że jest mniejszy popyt na specjalistyczne kursy lub że twórcy kursów mogą nie skupiać się na tworzeniu zaawansowanych materiałów edukacyjnych, być może z powodu większego wyzwania w tworzeniu treści na wyższym poziomie zaawansowania lub mniejszej grupy docelowej zdolnej do ich zrozumienia.

Podsumowując, wykres wskazuje na koncentrację oferty edukacyjnej na kursy ogólne i dla początkujących, przy ograniczonej ofercie dla uczących się na wyższych poziomach zaawansowania, co może wskazywać na potencjalne nisze rynkowe do rozwoju.

### Macierz korelacji

Zamiana danych jakościowych na ilościowe, aby móc je później przeanalizować
Level zmieniam na 
0 - All Levels
1 - Beginner Level
2 - Expert Level
3 - Intermediate Level

Subject zmieniam na
0 - Business Finance
1 - Graphic Design
2 - Musical Instruments
3 - Web Development
```{r}
data$is_paid <- ifelse(data$is_paid == "True", 1, 0)
data$level = as.integer(data$level) - 1
data$subject = as.integer(data$subject) - 1
```

```{r}
Cor_mat = data[, c(2:8, 10)]
chart.Correlation(Cor_mat, histogram = TRUE)
```

### Kilka obserwacji z danej macierzy korelacji

Istnieje silna dodatnia korelacja między liczbą lekcji a całkowitym czasem trwania kursu. To wskazuje, że zwiększona liczba lekcji jest zazwyczaj skorelowana z dłuższym czasem dostępu do treści kursu, co jest zgodne z oczekiwaniami, że bogatsza w treści oferta edukacyjna wymaga więcej czasu na jej przyswojenie.

Analiza wykazała również istotną dodatnią korelację między liczbą recenzji a liczbą subskrybentów. Jest to wskaźnik, że kursy o większej liczbie zapisanych uczestników generują proporcjonalnie większą liczbę recenzji. To zjawisko może świadczyć o większym zaangażowaniu użytkowników w kursy, które cieszą się większą popularnością.

Z analizy wynika, że poziom trudności kursu, określony przez autora, nie wykazuje korelacji z żadną inną mierzoną zmienną w zestawie danych. Może to sugerować, że stopień trudności kursu jest determinowany niezależnie od innych czynników, takich jak czas trwania kursu, liczba lekcji, czy popularność kursu wśród subskrybentów.

Ponadto, obserwacja negatywnej korelacji między statusem płatności kursu a liczbą subskrybentów może wskazywać na tendencję, że kursy oferowane bezpłatnie przyciągają większą liczbę uczestników. To zjawisko może podkreślać wpływ dostępności cenowej na decyzje o zapisaniu się na kurs przez potencjalnych uczestników.


### Miary asymetrii i koncentracji

```{r}
base::sapply(list(price=data$price,num_subscribers=data$num_subscribers,
                  num_reviews=data$num_reviews,num_lectures=data$num_lectures,
                  content_duration=data$content_duration),
             simplify = TRUE,
             FUN =  function(x){
             c(skewness = round(skewness(x),3),
               kurtosis = round(kurtosis(x,method = 'moment'),3))}
) %>% 
  as.data.frame() %>% 
  gt(rownames_to_stub = TRUE) %>% 
    tab_style(
    style=list(cell_borders(sides = c("r"), color = "gray50", weight = px(2))),
    locations=cells_stubhead()
    ) %>% 
  tab_options(
    column_labels.border.top.style = 'hidden'
  ) %>% 
  tab_style(
    style = cell_text(
      weight = 'bold',
      transform = 'uppercase'
    ),
    locations = cells_column_labels()
  ) %>% 
  tab_style(
    style = cell_text(
      weight = 'bold',
      style = 'italic'
    ),
    locations = cells_stub()
  )

```


## Modelowanie danych

```{r}
model_pusty <- lm(num_subscribers~-1,data = data_cleaned)
model_pelny <- lm(num_subscribers~price+num_reviews+num_lectures+content_duration + as.factor(level)+as.factor(subject),data=data_cleaned)
```

Selekcja w przód

```{r}
model1 <- step(model_pusty,scope = formula(model_pelny),direction = 'forward')
```

Eliminacja wsteczna

```{r}
model2 <- step(model_pelny,scope = formula(model_pelny),direction = 'backward')
```


```{r}
anova(model1,model2)
```

Na podstawie częściowego testu F dochodzimy do wniosku, że bardziej złożony model jest lepszy od prostszego modelu. Zatem dalszej analizie podamy model2.

## Obserwacje nietypowe

```{r}
plot(model2,which = 4:5)
cooks.distance(model2)[which(cooks.distance(model2)>0.5)]
```

Na podstawie wyżej ukazanych wykresów możemy stwierdzić, że w modelu znajdują się obserwacje nietypowe. Są to obserwacje numer 3199,3225,3227 oraz 2822


```{r}
data_new <- data_cleaned[-3227,][-3225,][-3199,][-2882,]

```

```{r}
model2 <- lm(num_subscribers ~ price + num_reviews + as.factor(level) + as.factor(subject), data=data_new)
```

```{r}
summary(model2)
```

```{r}
plot(model2)
```



## Podstawowe założenia

Liniowość
```{r}
resettest(model2)
raintest(model2)
```

Homoskedastyczność
```{r}
bptest(model2)
```

Autokorelacja
```{r}
dwtest(model2)
```

Egzogeniczność
```{r}
```

Normalność reszt
```{r warning=FALSE}
lillie.test(model2$residuals)
shapiro.test(model2$residuals)
cvm.test(model2$residuals)
ad.test(model2$residuals)
```


Wszędzie wszystko odrzucamy.


```{r}
nowa_wart <- data.frame(price=min(data$price),num_reviews=min(data$num_reviews),content_duration=min(data$content_duration),level=as.factor('Intermediate Level'),subject=as.factor('Web Development')) 
pred <- predict(model2,nowa_wart,interval = 'predict')
pred
```

### PCA

```{r}
data_cleaned
X <- data_cleaned[,c(3,5,6,8)]
X
pr <- prcomp(X,scale=T)

pr$rotation
pr$x %>% head

pr %>% 
  summary()

library(factoextra)
fviz_screeplot(pr)

fviz_contrib(pr,choice = 'var',axes=1)
fviz_contrib(pr,choice = 'var',axes=2)
#fviz_contrib(pr,choice = 'var',axes=3)
```


```{r}
PC1 <- pr$x[,1]
PC2 <- pr$x[,2]
#PC3 <- pr$x[,3]

mod <- lm(data_cleaned$`num_subscribers`~PC1+PC2)

summary(mod)
```


```{r}
plot(mod,which=1:6)

shapiro.test(mod$residuals)
nortest::ad.test(mod$residuals)
nortest::cvm.test(mod$residuals)
resettest(mod)
raintest(mod)
bptest(mod)
dwtest(mod)
```




################

```{r}
data_cleaned
X <- data_cleaned[,c(3,4,5,6)]
X
pr <- prcomp(X,scale=T)

pr$rotation
pr$x %>% head

pr %>% 
  summary()

library(factoextra)
fviz_screeplot(pr)

fviz_contrib(pr,choice = 'var',axes=1)
fviz_contrib(pr,choice = 'var',axes=2)
fviz_contrib(pr,choice = 'var',axes=3)
```


```{r}
PC1 <- pr$x[,1]
PC2 <- pr$x[,2]
PC3 <- pr$x[,3]

mod <- lm(data_cleaned$`content_duration`~PC1+PC2+PC3)

summary(mod)
```


las losowy 


```{r}
library(randomForest)
set.seed(42)  # używamy seed dla powtarzalności wyników

# używamy tej komendy, gdy mamy jakieś braki danych, las losowy uzupełnia te braki, co jest pomocne w późniejszej analizie
# rfImpute(num_subscribers ~ ., data = data_cleaned, iter = 6)  # przewidujemy liczbę subskrybentów, budujemy 6 lasów losowych
# u nas nie ma braków danych, więc jej nie używamy

# dzielenie danych na zbiór treningowy i testowy
split = createDataPartition(data_cleaned$num_subscribers, p = .8, list = F, times = 1)  # podział danych 
data_train = data_cleaned[split,]
data_test = data_clean[-split,]

model = randomForest(num_subscribers ~ .-level, data = data_train, proximity=  T)

# ocena modelu
predi = predict(model, data_test)
result = postResample(pred = predi, obs = data_test$num_subscribers)
result
varImpPlot(model) # wyższa wartość wskazuje wyższą ważność zmiennej w modelu, level ma małą w porównaniu do innych więc można ją wyżucić z modelu

# można jeszcze dodać wykresy błędów, ale nie wiem czy jest sens, kiedyś sprawdzę
```
Po usunięciu level z modelu zwiększyło się Rsquared, co oznacza, że model wyjaśnia więcej zmienności zmiennej objaśnianej